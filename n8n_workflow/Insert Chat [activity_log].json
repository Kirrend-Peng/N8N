{
  "name": "Insert Chat [activity_log]",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4fce7928-7b35-4682-8111-15cf14057d77",
              "name": "activity_id",
              "value": "={{ $('[activity_log]_input').item.json.activity_id }}",
              "type": "string"
            },
            {
              "id": "cf374d0a-9d81-4625-b58c-2dfc5ba8022d",
              "name": "chain_id",
              "value": "={{ $('[activity_log]_input').item.json.chain_id }}",
              "type": "string"
            },
            {
              "id": "3c036c3b-5dbb-42dd-bb6e-44f2bda1c4d1",
              "name": "activity_type",
              "value": "chat",
              "type": "string"
            },
            {
              "id": "81e518de-d217-4dcd-89a6-18473bc368b7",
              "name": "occurred_at",
              "value": "={{ $json.createdAt }}",
              "type": "object"
            },
            {
              "id": "bbb98196-af8c-427d-a062-fe57baf66bf6",
              "name": "details",
              "value": "={{$node[\"mappiing_conversation_log\"].json}}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -400,
        -304
      ],
      "id": "415895ac-c010-463c-9dcd-95478343a8b1",
      "name": "Mapping [activity_log]"
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "activity_log",
        "fields": "activity_id,chain_id,activity_type,occurred_at,details",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        -112,
        -304
      ],
      "id": "bfd3ba18-2fdc-4dec-9fd2-cee9e93f16a8",
      "name": "Insert documents",
      "credentials": {
        "mongoDb": {
          "id": "XhJV9sh6HSUrP479",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "collection": "user_identity",
        "options": {
          "projection": "{\n  \"_id\":0, \n  \"user_id\":1,\n  \"external_user_id\":1\n}"
        },
        "query": "=  {\n    \"provider\": \"line\",\n    \"bot_id\": \"{{ $('[activity_log]_input').first().json.bot_id }}\",\n  \"external_user_id\": { \"$in\": {{JSON.stringify( $node[\"SetParticipants\"].json.participants || []) }}\n  }\n  }"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        -1040,
        -304
      ],
      "id": "a9dcbdb2-baf1-4271-81a0-14fd2a6dcd10",
      "name": "Find_[user_identity]",
      "credentials": {
        "mongoDb": {
          "id": "XhJV9sh6HSUrP479",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "collection": "chat_rooms",
        "options": {},
        "query": "={\"chat_id\":{\"$in\":{{JSON.stringify( $item(0).$node[\"[activity_log]_input\"].json.participatingGroupsID || []) }}}}"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        -1424,
        -304
      ],
      "id": "7e03086e-5bc2-4843-8061-97e3c7163a9d",
      "name": "Find_[chat_rooms]",
      "credentials": {
        "mongoDb": {
          "id": "XhJV9sh6HSUrP479",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "activity_id"
            },
            {
              "name": "chain_id"
            },
            {
              "name": "activity_type"
            },
            {
              "name": "occurred_at",
              "type": "object"
            },
            {
              "name": "sender_id"
            },
            {
              "name": "source_type"
            },
            {
              "name": "source_id"
            },
            {
              "name": "source_platform"
            },
            {
              "name": "quoteToken"
            },
            {
              "name": "messages",
              "type": "array"
            },
            {
              "name": "participants",
              "type": "array"
            },
            {
              "name": "participatingGroupsID",
              "type": "array"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1664,
        -304
      ],
      "id": "f2991e09-7076-4a36-8a67-c5e68c7eb9e3",
      "name": "[activity_log]_input2"
    },
    {
      "parameters": {
        "jsCode": "// 1) 從另一個節點抓出所有聊天室 items\n//    Node 名稱要與畫面上的顯示一致（含中括號）\nconst chatItems = $items('Find_[chat_rooms]', 0, 0); // -> [{json: {...}}, ...]\n\n// 2) 建立去重集合，把所有 members 塞進來\nconst uniq = new Set();\n\nfor (const item of chatItems) {\n  const m = item.json?.members;\n  if (Array.isArray(m)) {\n    for (const id of m) {\n      if (typeof id === 'string' && id.trim()) {\n        uniq.add(id.trim());\n      }\n    }\n  }\n}\n\n// 3) 從本節點主輸入([activity_log]_input) 取得 sender_id\n//    建議將 Code 節點的主要輸入接到 [activity_log]_input\nconst senderId = $('[activity_log]_input').first().json?.sender_id;\nif (typeof senderId === 'string' && senderId.trim()) {\n  // 不在集合才加入\n  if (!uniq.has(senderId.trim())) {\n    uniq.add(senderId.trim());\n  }\n}\n\n// 4) 只輸出 participants（單一 item）\nreturn [{ json: { participants: Array.from(uniq) } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1232,
        -304
      ],
      "id": "5cbb078c-1da4-4c85-ab5f-39ee551aa670",
      "name": "SetParticipants"
    },
    {
      "parameters": {
        "jsCode": "// === 讀來源節點 ===\nconst activity = ($items(\"[activity_log]_input\")[0] || {}).json || {};\nconst identityItems = $items(\"Find_[user_identity]\") || [];\nconst setParticipantsItem = ($items(\"SetParticipants\")[0] || {}).json || {};\n\n// === external_user_id -> user_id 對照表 ===\nconst idMap = new Map();\nfor (const it of identityItems) {\n  const j = it.json || it; // 兼容某些節點只回傳 json\n  if (j.external_user_id && j.user_id) {\n    idMap.set(j.external_user_id, j.user_id);\n  }\n}\n\n// === 參與者（participants）===\n// sender：由 activity.sender_id 來\nconst senderExt = activity.sender_id;\n\n// 從 SetParticipants 取得 external user id 陣列\nconst extList = Array.isArray(setParticipantsItem.participants)\n  ? setParticipantsItem.participants\n  : [];\n\n// 做成去重集合\nconst uniqExt = new Set(extList);\n\n// 確保 sender 一定在 participants 清單裡（如果 SetParticipants 漏掉）\nif (senderExt && !uniqExt.has(senderExt)) {\n  uniqExt.add(senderExt);\n}\n\n// 只有「有 mapping」的 external_user_id 會留下，其餘直接丟掉\nconst participants = [];\nfor (const ext of uniqExt) {\n  const mappedId = idMap.get(ext);\n  if (!mappedId) {\n    // 沒有對應 user_id，直接略過\n    continue;\n  }\n\n  participants.push({\n    id: String(mappedId),                      // 一律用 user_id\n    role: ext === senderExt ? \"sender\" : \"recipient\",\n  });\n}\n\n// ⚠️ 不再額外加入 bot 參與者\n\n\n// === messages ===\n// type 使用 activity.messages[i].type\n// payload：除了 type / markAsReadToken 以外的欄位\nconst rawMessages = Array.isArray(activity.messages) ? activity.messages : [];\nlet messages;\n\nif (rawMessages.length === 0) {\n  messages = [\n    {\n      type: \"meta\",\n      payload: {\n        note: \"no messages in activity_log\",\n        quoteToken: activity.quoteToken ?? null,\n      },\n    },\n  ];\n} else {\n  messages = rawMessages.map(m => {\n    if (!m || typeof m !== \"object\") {\n      return {\n        type: \"meta\",\n        payload: { value: m },\n      };\n    }\n\n    // markAsReadToken 拆出來但不放進 payload 裡\n    const { type, markAsReadToken, ...rest } = m;\n\n    const finalType = (typeof type === \"string\" && type) ? type : \"meta\";\n\n    return {\n      type: finalType,\n      payload: rest,   // 這裡已經不包含 markAsReadToken\n    };\n  });\n}\n\n// === source ===\nconst source = {\n  type: String(activity.source_type || \"\"),\n  platform: String(activity.source_platform || \"\"),\n  source_id: String(activity.source_id || \"\"),\n};\n\n// === 其他欄位 ===\nconst doc = {\n  participants,\n  messages,\n  source,\n  quoteToken: activity.quoteToken ?? null,\n  sent_at: activity.occurred_at ? new Date(activity.occurred_at) : new Date(),\n  createdAt: new Date(),\n};\n\nreturn [{ json: doc, pairedItem: 0 }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        -304
      ],
      "id": "0ebc5edb-0598-4e23-a30f-efe9aa5c743b",
      "name": "mappiing_conversation_log"
    },
    {
      "parameters": {
        "content": "## 整合user_info chatbot_info\n\nuser_info 需添加user_type\n",
        "width": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        -576
      ],
      "id": "c8c34879-6da3-4c49-b1d8-057af7652f16",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## 建立view整合user_info、user_identity\n中的\nuser_id\nuser_type\nexternal_id\n?\n\n或log 僅記錄id也是可以的\n",
        "height": 272,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -784,
        -672
      ],
      "id": "8e446568-cf90-4a2d-bae0-6e6343fa54c3",
      "name": "Sticky Note1"
    }
  ],
  "pinData": {},
  "connections": {
    "Mapping [activity_log]": {
      "main": [
        [
          {
            "node": "Insert documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find_[user_identity]": {
      "main": [
        [
          {
            "node": "mappiing_conversation_log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find_[chat_rooms]": {
      "main": [
        [
          {
            "node": "SetParticipants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[activity_log]_input2": {
      "main": [
        [
          {
            "node": "Find_[chat_rooms]",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SetParticipants": {
      "main": [
        [
          {
            "node": "Find_[user_identity]",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mappiing_conversation_log": {
      "main": [
        [
          {
            "node": "Mapping [activity_log]",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ef232ca4-ba1d-40c8-ab3f-3fec8a700be0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ce366878273a0c079b30629c5438592b1b601f9378d29abdf8727b9dd05db8f6"
  },
  "id": "HNmIfxW8QH4VmmvU",
  "tags": []
}